// ‰øÆÂ§çÁâà‰∏ªÂ∫îÁî®ÁªÑ‰ª∂
const App = () => {
    const { Layout, message } = antd;
    const { Sider, Header, Content } = Layout;
    
    const [currentPage, setCurrentPage] = React.useState('Dashboard');
    const [collapsed, setCollapsed] = React.useState(false);
    const [isAuthenticated, setIsAuthenticated] = React.useState(false);
    const [user, setUser] = React.useState(null);
    const [loading, setLoading] = React.useState(true);
    const [renderKey, setRenderKey] = React.useState(0); // Âº∫Âà∂ÈáçÊñ∞Ê∏≤ÊüìÁöÑkey
    
    const [notifications, setNotifications] = React.useState([
        {
            type: 'warning',
            title: 'Á≥ªÁªüÂçáÁ∫ß',
            content: 'Á≥ªÁªüÂ∞Ü‰∫é‰ªäÊôö24:00ËøõË°åÁª¥Êä§ÂçáÁ∫ß',
            time: '10ÂàÜÈíüÂâç',
            read: false
        },
        {
            type: 'info',
            title: 'Êñ∞ÁâàÊú¨ÂèëÂ∏É',
            content: 'v2.1.0ÁâàÊú¨Â∑≤ÂèëÂ∏ÉÔºåÊñ∞Â¢ûÊâπÈáèÊìç‰ΩúÂäüËÉΩ',
            time: '1Â∞èÊó∂Ââç',
            read: true
        }
    ]);

    // ÂàùÂßãÂåñËÆ§ËØÅÁä∂ÊÄÅ
    React.useEffect(() => {
        checkAuthStatus();
        
        // ËÆæÁΩÆÂÆöÊó∂Ê£ÄÊü•ËÆ§ËØÅÁä∂ÊÄÅ
        const authCheckInterval = setInterval(() => {
            if (!AuthUtils.refreshAuth()) {
                handleLogout();
            }
        }, 5 * 60 * 1000); // ÊØè5ÂàÜÈíüÊ£ÄÊü•‰∏ÄÊ¨°

        return () => clearInterval(authCheckInterval);
    }, []);

    // Ê£ÄÊü•ËÆ§ËØÅÁä∂ÊÄÅ
    const checkAuthStatus = () => {
        try {
            setLoading(true);
            
            if (AuthUtils.isAuthenticated() && !AuthUtils.isTokenExpired()) {
                const userData = AuthUtils.getCurrentUser();
                if (userData) {
                    setUser(userData);
                    setIsAuthenticated(true);
                    console.log('Áî®Êà∑Â∑≤ÁôªÂΩï:', userData.name);
                } else {
                    setIsAuthenticated(false);
                }
            } else {
                setIsAuthenticated(false);
                AuthUtils.logout(); // Ê∏ÖÈô§ËøáÊúüÁöÑËÆ§ËØÅ‰ø°ÊÅØ
            }
        } catch (error) {
            console.error('ËÆ§ËØÅÁä∂ÊÄÅÊ£ÄÊü•Â§±Ë¥•:', error);
            setIsAuthenticated(false);
        } finally {
            setLoading(false);
        }
    };

    // Â§ÑÁêÜÁôªÂΩï
    const handleLogin = (userData) => {
        try {
            setUser(userData);
            setIsAuthenticated(true);
            message.success(`Ê¨¢ËøéÂõûÊù•Ôºå${userData.name}ÔºÅ`);
            
            // ËÆ∞ÂΩïÁôªÂΩïÊàêÂäü
            AuthUtils.logActivity('login_success', {
                username: userData.username,
                loginTime: new Date().toISOString()
            });
        } catch (error) {
            console.error('ÁôªÂΩïÂ§ÑÁêÜÂ§±Ë¥•:', error);
            message.error('ÁôªÂΩïÂ§ÑÁêÜÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
        }
    };

    // Â§ÑÁêÜÈÄÄÂá∫ÁôªÂΩï
    const handleLogout = () => {
        try {
            const currentUser = AuthUtils.getCurrentUser();
            AuthUtils.logout();
            setUser(null);
            setIsAuthenticated(false);
            setCurrentPage('Dashboard'); // ÈáçÁΩÆÂà∞È¶ñÈ°µ
            
            message.info(currentUser ? `${currentUser.name}ÔºåÊÇ®Â∑≤ÂÆâÂÖ®ÈÄÄÂá∫` : 'Â∑≤ÈÄÄÂá∫ÁôªÂΩï');
        } catch (error) {
            console.error('ÈÄÄÂá∫ÁôªÂΩïÂ§±Ë¥•:', error);
            message.error('ÈÄÄÂá∫ÁôªÂΩïÂ§±Ë¥•');
        }
    };

    const handlePageChange = (page) => {
        console.log('üöÄ [FIXED] È°µÈù¢ÂàáÊç¢ÂºÄÂßã');
        console.log('üéØ [FIXED] ÁõÆÊ†áÈ°µÈù¢:', page);
        console.log('üìç [FIXED] ÂΩìÂâçÈ°µÈù¢:', currentPage);
        
        // ËÆæÁΩÆÊñ∞È°µÈù¢
        setCurrentPage(page);
        
        // Âº∫Âà∂ÈáçÊñ∞Ê∏≤Êüì
        setRenderKey(prev => prev + 1);
        
        console.log('‚úÖ [FIXED] È°µÈù¢Áä∂ÊÄÅÂ∑≤Êõ¥Êñ∞');
        console.log('üîÑ [FIXED] Âº∫Âà∂ÈáçÊñ∞Ê∏≤Êüì key:', renderKey + 1);
        
        // ËÆ∞ÂΩïÈ°µÈù¢ËÆøÈóÆ
        if (isAuthenticated) {
            AuthUtils.logActivity('page_visit', {
                page: page,
                timestamp: new Date().toISOString()
            });
        }
    };

    const handleToggleCollapse = () => {
        setCollapsed(!collapsed);
        
        // ‰øùÂ≠òÁî®Êà∑ÂÅèÂ•Ω
        if (isAuthenticated) {
            AuthUtils.setUserPreference('sidebarCollapsed', !collapsed);
        }
    };

    const handleNotificationClick = () => {
        console.log('Êü•ÁúãÂÖ®ÈÉ®ÈÄöÁü•');
        handlePageChange('notifications');
    };

    // Âä†ËΩΩÁî®Êà∑ÂÅèÂ•ΩËÆæÁΩÆ
    React.useEffect(() => {
        if (isAuthenticated) {
            const savedCollapsed = AuthUtils.getUserPreference('sidebarCollapsed', false);
            setCollapsed(savedCollapsed);
        }
    }, [isAuthenticated]);

    // ÁõëÂê¨È°µÈù¢ÂèòÂåñ
    React.useEffect(() => {
        console.log('üì± [FIXED] useEffect Ëß¶Âèë - È°µÈù¢:', currentPage);
        console.log('üîß [FIXED] renderKey:', renderKey);
    }, [currentPage, renderKey]);

    const renderContent = () => {
        console.log('üé® [FIXED] renderContent ÂºÄÂßãÊ∏≤Êüì');
        console.log('üìÑ [FIXED] ÂΩìÂâçÈ°µÈù¢:', currentPage);
        console.log('üîë [FIXED] renderKey:', renderKey);
        
        // ÂÆåÊï¥ÁöÑÁªÑ‰ª∂Êò†Â∞ÑË°®
        const pageComponents = {
            // Á≥ªÁªüÈ¶ñÈ°µ
            'Dashboard': window.Dashboard,
            'dashboard': window.Dashboard,
            
            // ÂÜÖÂÆπÁÆ°ÁêÜ
            'ContentPublish': window.ContentPublish,
            'content-publish': window.ContentPublish,
            'ContentManagement': window.ContentManagement,
            'content-list': window.ContentManagement,
            
            // ÂÆ°Ê†∏ÁÆ°ÁêÜ
            'ComplaintManagement': window.ComplaintManagement,
            'complaint': window.ComplaintManagement,
            'ContentTagManagement': window.ContentTagManagement,
            'tags': window.ContentTagManagement,
            'ReviewManagement': window.ReviewManagement,
            'ai-review': window.AIReview,
            'AIReview': window.AIReview,
            'AuditFlowManagement': window.AuditFlowManagement,
            'approval-flow': window.AuditFlowManagement,
            'work-approval': window.AuditFlowManagement,
            'ExhibitionReview': window.ExhibitionReview,
            'exhibitor-approval': window.ExhibitionReview,
            'approval-management': window.AuditFlowManagement,
            
            // Â±ï‰ºöÁÆ°ÁêÜ
            'ExhibitionManagement': window.ExhibitionManagement,
            'exhibition-list': window.ExhibitionManagement,
            'RegistrationManagement': window.RegistrationManagement,
            'registration-management': window.RegistrationManagement,
            'registration-entrance': window.RegistrationManagement,
            'BoothManagement': window.BoothManagement,
            'venue-info': window.BoothManagement,
            'ExhibitorQuery': window.ExhibitorQuery,
            'exhibitor-details': window.ExhibitorQuery,
            'MeetingActivityManagement': window.MeetingActivityManagement,
            'meeting-activity': window.MeetingActivityManagement,
            'ExhibitorBasicInfo': window.ExhibitorBasicInfo,
            'exhibitor-basic': window.ExhibitorBasicInfo,
            'ProductInfo': window.ProductInfo,
            'product-info': window.ProductInfo,
            'ExhibitorActivityInfo': window.ExhibitorActivityInfo,
            'exhibitor-activity': window.ExhibitorActivityInfo,
            'BusinessMatching': window.BusinessMatching,
            'business-matching': window.BusinessMatching,
            'ExhibitorInfo': window.ExhibitorInfo,
            'exhibitor-info': window.ExhibitorInfo,
            
            // ËøêËê•ÁÆ°ÁêÜ
            'UserAnalysis': window.UserAnalysis,
            'user-analysis': window.UserAnalysis,
            'BehaviorStats': window.BehaviorStats,
            'app-behavior': window.BehaviorStats,
            'basic-behavior': window.BehaviorStats,
            'DataAnalysis': window.DataAnalysis,
            'function-analysis': window.DataAnalysis,
            'OperationalStats': window.OperationalStats,
            'exception-stats': window.OperationalStats,
            'UserBehaviorStats': window.UserBehaviorStats,
            'data-overview': window.UserBehaviorStats,
            'BehaviorAnalysis': window.BehaviorAnalysis,
            'deep-behavior': window.BehaviorAnalysis,
            'DataManagement': window.DataManagement,
            'system-monitor': window.DataManagement,
            'FeedbackManagement': window.FeedbackManagement,
            'feedback-list': window.FeedbackManagement,
            
            // Á≥ªÁªüÁÆ°ÁêÜ
            'UserManagement': window.UserManagement,
            'user-list': window.UserManagement,
            'OrganizationManagement': window.OrganizationManagement,
            'organization': window.OrganizationManagement,
            'AdminManagement': window.AdminManagement,
            'admin-role': window.AdminManagement,
            'RoleManagement': window.RoleManagement,
            'non-admin-role': window.RoleManagement,
            'LogManagement': window.LogManagement,
            'user-operation-logs': window.LogManagement,
            'LoginLogoutLogs': window.LoginLogoutLogs,
            'login-logout-logs': window.LoginLogoutLogs,
            'ContentPublishLogs': window.ContentPublishLogs,
            'content-publish-logs': window.ContentPublishLogs,
            'ApprovalLogs': window.ApprovalLogs,
            'approval-logs': window.ApprovalLogs,
            'AIManagement': window.AIManagement,
            'agent-management': window.AIManagement,
            'knowledge-base': window.AIManagement,
            'MenuManagement': window.MenuManagement,
            'menu-management': window.MenuManagement,
            'UserProfile': window.UserProfile,
            'profile': window.UserProfile,
            
            // ÂÖ∂‰ªñÈ°µÈù¢
            'LiveManagement': window.LiveManagement,
            'MessageManagement': window.MessageManagement,
            'VersionManagement': window.VersionManagement,
            'SystemSettings': window.SystemSettings
        };
        
        const PageComponent = pageComponents[currentPage];
        console.log('üîç [FIXED] Êü•ÊâæÁªÑ‰ª∂:', currentPage, 'ÁªìÊûú:', !!PageComponent);
        
        if (PageComponent) {
            console.log('‚úÖ [FIXED] Ê∏≤ÊüìÈ°µÈù¢ÁªÑ‰ª∂:', currentPage);
            try {
                return React.createElement(PageComponent, { key: `${currentPage}-${renderKey}` });
            } catch (error) {
                console.error('‚ùå [FIXED] È°µÈù¢ÁªÑ‰ª∂Ê∏≤ÊüìÂ§±Ë¥•:', error);
                return React.createElement('div', {
                    style: { 
                        padding: '24px', 
                        textAlign: 'center',
                        background: '#fff',
                        margin: '24px',
                        borderRadius: '8px',
                        border: '1px solid #ff4d4f'
                    }
                }, [
                    React.createElement('h2', { key: 'title', style: { color: '#ff4d4f' } }, `È°µÈù¢ÁªÑ‰ª∂ ${currentPage} Ê∏≤ÊüìÂ§±Ë¥•`),
                    React.createElement('p', { key: 'error' }, error.message),
                    React.createElement('button', {
                        key: 'reload',
                        onClick: () => location.reload(),
                        style: { padding: '8px 16px', marginTop: '16px' }
                    }, 'ÈáçÊñ∞Âä†ËΩΩ')
                ]);
            }
        }
        
        // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÂØπÂ∫îÁªÑ‰ª∂ÔºåÊòæÁ§∫ÈîôËØØÈ°µÈù¢
        console.log('‚ùå [FIXED] Êú™ÊâæÂà∞È°µÈù¢ÁªÑ‰ª∂:', currentPage);
        return React.createElement('div', {
            style: { 
                padding: '24px', 
                textAlign: 'center',
                background: '#fff',
                margin: '24px',
                borderRadius: '8px',
                border: '1px solid #faad14'
            }
        }, [
            React.createElement('h2', { key: 'title', style: { color: '#faad14' } }, `È°µÈù¢ "${currentPage}" Êú™ÊâæÂà∞`),
            React.createElement('p', { key: 'msg' }, 'ËØ∑Ê£ÄÊü•È°µÈù¢ÁªÑ‰ª∂ÊòØÂê¶Ê≠£Á°ÆÂä†ËΩΩ'),
            React.createElement('button', {
                key: 'back',
                onClick: () => handlePageChange('Dashboard'),
                style: { padding: '8px 16px', marginTop: '16px' }
            }, 'ËøîÂõûÈ¶ñÈ°µ')
        ]);
    };

    // Âä†ËΩΩ‰∏≠Áä∂ÊÄÅ
    if (loading) {
        return React.createElement('div', {
            className: 'loading-spinner'
        }, [
            React.createElement('div', {
                key: 'loading-content',
                style: { textAlign: 'center' }
            }, [
                React.createElement('div', {
                    key: 'icon',
                    style: { fontSize: '48px', marginBottom: '16px' }
                }, 'üöá'),
                React.createElement('div', {
                    key: 'title',
                    style: { fontSize: '20px', fontWeight: 'bold', marginBottom: '16px' }
                }, '‰∫∫Ê∞ëÂüéËΩ®2.0ËøêËê•ÁÆ°ÁêÜÂêéÂè∞'),
                React.createElement('div', {
                    key: 'message',
                    style: { marginTop: '16px', color: '#64748b' }
                }, 'Ê≠£Âú®È™åËØÅÁôªÂΩïÁä∂ÊÄÅ...')
            ])
        ]);
    }

    // Êú™ÁôªÂΩïÁä∂ÊÄÅÔºåÊòæÁ§∫ÁôªÂΩïÈ°µÈù¢
    if (!isAuthenticated) {
        return React.createElement(window.LoginPage, {
            onLogin: handleLogin
        });
    }

    // Â∑≤ÁôªÂΩïÁä∂ÊÄÅÔºåÊòæÁ§∫‰∏ªÂ∫îÁî®ÁïåÈù¢
    return React.createElement(ErrorBoundary, {}, 
        React.createElement(Layout, {
            className: 'app-container',
            style: { minHeight: '100vh' }
        }, [
            // Â∑¶‰æßÂØºËà™
            React.createElement(Sider, {
                key: 'sider',
                width: collapsed ? 80 : 240,
                collapsed: collapsed,
                collapsible: false,
                style: {
                    overflow: 'auto',
                    height: '100vh',
                    position: 'fixed',
                    left: 0,
                    top: 0,
                    bottom: 0
                }
            }, React.createElement(Navigation, {
                currentPage: currentPage,
                onPageChange: handlePageChange,
                collapsed: collapsed,
                onToggleCollapse: handleToggleCollapse,
                user: user
            })),

            // Âè≥‰æß‰∏ª‰Ωì
            React.createElement(Layout, {
                key: 'main',
                style: { 
                    marginLeft: collapsed ? 80 : 240,
                    transition: 'margin-left 0.3s'
                }
            }, [
                // È°∂ÈÉ®Êìç‰ΩúÊ†è
                React.createElement(Header, {
                    key: 'header',
                    style: { 
                        position: 'fixed',
                        top: 0,
                        right: 0,
                        left: collapsed ? 80 : 240,
                        zIndex: 1000,
                        padding: 0,
                        height: 64,
                        transition: 'left 0.3s'
                    }
                }, React.createElement(TopBar, {
                    user: user,
                    notifications: notifications,
                    onNotificationClick: handleNotificationClick,
                    onLogout: handleLogout
                })),

                // ‰∏ªÂÜÖÂÆπÂå∫ - ‰ΩøÁî®renderKeyÁ°Æ‰øùÈáçÊñ∞Ê∏≤Êüì
                React.createElement(Content, {
                    key: `main-content-${currentPage}-${renderKey}`,
                    style: {
                        marginTop: 64,
                        padding: '24px',
                        background: '#f5f7fa',
                        minHeight: 'calc(100vh - 64px)'
                    }
                }, renderContent())
            ])
        ])
    );
};

console.log('üöÄ [FIXED] App ÁªÑ‰ª∂ÂÆö‰πâÂÆåÊàêÔºåÂáÜÂ§áÊåÇËΩΩÂà∞ window');
window.App = App;
console.log('‚úÖ [FIXED] App ÁªÑ‰ª∂Â∑≤ÊåÇËΩΩÂà∞ window.App'); 